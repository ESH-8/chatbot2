const messages = document.getElementById("messages");
const userInput = document.getElementById("userInput");
const sendBtn = document.getElementById("sendBtn");

// Variable pour savoir si on est dans une "conversation spéciale"
let conversationState = null;

// Base de connaissances
const knowledgeBase = [
  {
    keywords: ["imprimante", "printer", "impression"],
    response:
      "Si vous ne voyez pas l’imprimante :<br>1️ Redémarrez votre session.<br>2️ Débrancher rebrancher le câble jaune (réseau) <br>3 Si cela ne fonctionne pas, appelez le support IT au 2100.",
  },
  {
    keywords: ["wifi", "wifi public", "SSID public", "mot de passe wifi"],
    response: "Le code du Wi-Fi public est : <b>RfdX2133%m</b>",
  },
  {
    keywords: ["écran", "dupliqué", "double écran", "souris"],
    response:
      "Pour résoudre un écran dupliqué ou une souris discontinue :<br>1️⃣ Fermez votre session.<br>2️⃣ Faites <b>Windows + O</b> jusqu’à ce que la souris circule correctement.",
  },
  {
    keywords: ["raccourcis", "raccourci"],
    response:
      "Pour ajouter un raccourci à votre bureau :<br>1️⃣ Aller dans l'icône banque de raccourcis située sur votre bureau.<br>2️⃣ Copier-coller le raccourci voulu sur votre bureau. --> Si le raccourci n'est pas disponible dans la banque de raccourcis, faire un bon SPOC",
  },
  {
    keywords: ["visio", "son", "caméra", "visioconférence"],
    response: "Pour résoudre votre problème, suivez la procédure suivante :<br>lien vers la procédure.",
  },
  {
    keywords: ["internet", "connexion"],
    response:
      "Etes vous sur un PC portable ou fixe ?<br>" +
      "👉 Tapez <b>1</b> PC portable<br>" +
      "👉 Tapez <b>2</b> PC fixe",
  },
  {
    keywords: ["outlook"],
    response:
      "Quel est votre problème avec Outlook ?<br>" +
      "👉 Tapez <b>1</b> si Outlook ne démarre pas<br>" +
      "👉 Tapez <b>2</b> si vous avez une erreur de connexion<br>" +
      "👉 Tapez <b>3</b> si Outlook est ralenti",
  },
];

// Fonction d'affichage des messages
function addMessage(text, sender) {
  const div = document.createElement("div");
  div.classList.add("msg", sender);
  div.innerHTML = text;
  messages.appendChild(div);
  messages.scrollTop = messages.scrollHeight;
}

// Gestion des réponses
function getBotResponse(input) {
  input = input.toLowerCase();

  // Cas spécial : si on est en mode Outlook
  if (conversationState === "outlook") {
    if (input === "1") {
      conversationState = null;
      return "Solution : Fermez et redémarrez Outlook. Si ça ne marche pas, redémarrez votre PC.";
    }
    if (input === "2") {
      conversationState = null;
      return "Solution : Vérifiez votre mot de passe. Si le problème persiste, contactez le support IT (2100) afin qu'on vous le réinitialise.";
    }
    if (input === "3") {
      conversationState = null;
      return "Solution : Effacez les cookies en suivant la procédure suivante : .";
    }
  }

  // Recherche dans la base
  for (let item of knowledgeBase) {
    for (let keyword of item.keywords) {
      if (input.includes(keyword)) {
        if (keyword === "outlook") {
          conversationState = "outlook"; // On active le mode spécial
        }
        return item.response;
      }
    }
  }

  // Cas spécial : si on est en mode internet
  if (conversationState === "internet") {
    if (input === "1") {
      conversationState = null;
      return "Solution : Vérifiez votre connexion WIFI et le mot de passe.";
    }
    if (input === "2") {
      conversationState = null;
      return "Solution : débranchez rebrancher le câble réseau noir ou gris";
    }
  }

  // Recherche dans la base
  for (let item of knowledgeBase) {
    for (let keyword of item.keywords) {
      if (input.includes(keyword)) {
        if (keyword === "internet") {
          conversationState = "internet"; // On active le mode spécial
        }
        return item.response;
      }
    }
  }

  return "Désolé, je n'ai pas compris. Veuillez contacter le support IT au 2100.";
}

// Envoi du message
function sendMessage() {
  const text = userInput.value.trim();
  if (text === "") return;
  addMessage(text, "user");
  const response = getBotResponse(text);
  setTimeout(() => addMessage(response, "bot"), 500);
  userInput.value = "";
}

sendBtn.addEventListener("click", sendMessage);
userInput.addEventListener("keypress", function (e) {
  if (e.key === "Enter") sendMessage();
});
